## CVE-2019-9746

### 0x00 Description

I found a NULL pointer dereference in libwebm-1.0.0.27-354-g20ac809.

### 0x01 Analysis

The buggy codes in function `OutputCluster` and function `OutputTracks` are as below:

```
              if (track_type == mkvparser::Track::kVideo) {
                const std::string codec_id = track->GetCodecId(); <= NUll pointer dereference
                const std::string v_vp9 = "V_VP9";
                if (codec_id == v_vp9) {
                ...
        
        
 			  if (!encrypted_frame || sub_sample_encrypt) {
                data += frame_offset;
                frame_size -= frame_offset;

                const string codec_id = track->GetCodecId(); <= NUll pointer dereference
                if (codec_id == "V_VP8") {
                  PrintVP8Info(data, frame_size, o);
                } else if (codec_id == "V_VP9") {
                  PrintVP9Info(data, frame_size, o, time_ns, stats, parser,
                               level_stats);
                }
              }
```

When we debug the poc we can see the value of field *codecID* is NULL(0x0), then a SIGABRT will happen.

```
 → 1021                     const string codec_id = track->GetCodecId(); // crash here

gef➤  p *(const mkvparser::Track *) track
$1 = {
  _vptr.Track = 0x526b88 <vtable for mkvparser::VideoTrack+16>, 
  m_pSegment = 0x611000009f00, 
  m_element_start = 0xe2, 
  m_element_size = 0x1c, 
  m_info = {
    type = 0x1, 
    number = 0x1, 
    uid = 0x1, 
    defaultDuration = 0x0, 
    codecDelay = 0x0, 
    seekPreRoll = 0x0, 
    nameAsUTF8 = 0x0, 
    language = 0x0, 
    codecId = 0x0, 
    codecNameAsUTF8 = 0x0, 
    codecPrivate = 0x0, 
    codecPrivateSize = 0x0, 
    lacing = 0x1, 
    settings = {
      start = 0xf7, 
      size = 0x7
    }
  }, 
  m_eos = {
    <mkvparser::BlockEntry> = {
      _vptr.BlockEntry = 0x526b58 <vtable for mkvparser::Track::EOSBlock+16>, 
      m_pCluster = 0x0, 
      m_index = 0x8000000000000000
    }, <No data fields>}, 
  content_encoding_entries_ = 0x0, 
  content_encoding_entries_end_ = 0x0
}
```

This issue is a typical case of CWE-476: NULL Pointer Dereference.

### 0x02 Deep Reason

However, the deep reason of this issue lies in /libwebm/mkvparser/mkvparser.cc. The poc is a invalid webm file which leaks codecId and many other fields, but there is no strict validity check to those required fields. To avoid potential bugs in libwebm, it could be made more strict in checking format conformance.

```
5833 } else if (id == libwebm::kMkvCodecID) {
5834      const long status = UnserializeString(pReader, pos, size, 
5835 info.codecId);
5836
5837      if (status)
5838        return status;
5839    }

```

### 0x03 Patch

```
@@ -177,6 +177,8 @@
   return wstr;
 }
 
+string ToString(const char* str) { return string((str == NULL) ? "" : str); }
+
 void OutputEBMLHeader(const mkvparser::EBMLHeader& ebml, FILE* o,
                       Indent* indent) {
   fprintf(o, "EBML Header:\n");
@@ -376,7 +378,7 @@
               static_cast<int>(private_size));
 
       if (track_type == mkvparser::Track::kVideo) {
-        const std::string codec_id = track->GetCodecId();
+        const std::string codec_id = ToString(track->GetCodecId());
         const std::string v_vp9 = "V_VP9";
         if (codec_id == v_vp9) {
           libwebm::Vp9CodecFeatures features;
@@ -1018,7 +1020,7 @@
                 data += frame_offset;
                 frame_size -= frame_offset;
 
-                const string codec_id = track->GetCodecId();
+                const string codec_id = ToString(track->GetCodecId());
                 if (codec_id == "V_VP8") {
                   PrintVP8Info(data, frame_size, o);
                 } else if (codec_id == "V_VP9") {
```



### 0x04 References

[CVE entry](http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2019-9746)















